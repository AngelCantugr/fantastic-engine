/**
 * GitHub Streak Saver Bot
 * Automatically generates daily learning notes to maintain your GitHub contribution streak
 */

import { format } from "@std/datetime";
import { join } from "@std/path";
import { ensureDir } from "@std/fs";

interface LearningNote {
  date: string;
  dayOfWeek: string;
  topics: string[];
  insights: string[];
  nextSteps: string[];
  mood: string;
  focusLevel: number;
}

const MOOD_EMOJIS = ["ğŸ˜´", "ğŸ˜", "ğŸ™‚", "ğŸ˜Š", "ğŸ”¥", "ğŸš€"];
const TOPICS_POOL = [
  "Rust fundamentals",
  "WebAssembly integration",
  "TypeScript patterns",
  "Python async programming",
  "System design",
  "Distributed systems",
  "API design",
  "Database optimization",
  "DevOps practices",
  "Testing strategies",
  "Code refactoring",
  "Performance optimization",
];

function randomChoice<T>(array: T[]): T {
  return array[Math.floor(Math.random() * array.length)];
}

function randomSample<T>(array: T[], count: number): T[] {
  const shuffled = [...array].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

function generateLearningNote(): LearningNote {
  const now = new Date();
  const date = format(now, "yyyy-MM-dd");
  const dayOfWeek = format(now, "EEEE");

  return {
    date,
    dayOfWeek,
    topics: randomSample(TOPICS_POOL, Math.floor(Math.random() * 3) + 1),
    insights: [
      "Learned something new about async/await patterns",
      "Discovered a better way to handle error cases",
      "Understood the tradeoffs between different approaches",
    ].slice(0, Math.floor(Math.random() * 2) + 1),
    nextSteps: [
      "Deep dive into advanced patterns",
      "Build a practical example",
      "Review documentation",
    ].slice(0, Math.floor(Math.random() * 2) + 1),
    mood: randomChoice(MOOD_EMOJIS),
    focusLevel: Math.floor(Math.random() * 10) + 1,
  };
}

function formatNoteAsMarkdown(note: LearningNote): string {
  return `# Learning Note - ${note.date}

**Day:** ${note.dayOfWeek} | **Mood:** ${note.mood} | **Focus:** ${"â­".repeat(note.focusLevel)}/10

## Topics Covered

${note.topics.map((topic) => `- ${topic}`).join("\n")}

## Key Insights

${note.insights.map((insight) => `- ${insight}`).join("\n")}

## Next Steps

${note.nextSteps.map((step) => `- [ ] ${step}`).join("\n")}

---

*Auto-generated by GitHub Streak Saver Bot ğŸ¤–*
`;
}

async function saveNote(content: string, date: string): Promise<string> {
  const notesDir = join(Deno.cwd(), "notes");
  await ensureDir(notesDir);

  const filename = `learning-${date}.md`;
  const filepath = join(notesDir, filename);

  await Deno.writeTextFile(filepath, content);

  return filepath;
}

async function generateWeeklySummary(): Promise<void> {
  const now = new Date();
  const weekNumber = Math.floor((now.getTime() / (7 * 24 * 60 * 60 * 1000)));
  const summaryFile = join(Deno.cwd(), "notes", `week-${weekNumber}-summary.md`);

  const summary = `# Weekly Summary - Week ${weekNumber}

## Overview

This week focused on building consistent learning habits.

## Achievements

- ğŸ“ Maintained daily learning notes
- ğŸ”¥ Kept GitHub contribution streak alive
- ğŸ¯ Made progress on multiple experiments

## Reflection

Regular documentation helps track progress and build momentum.

---

*Generated by GitHub Streak Saver Bot*
`;

  await Deno.writeTextFile(summaryFile, summary);
  console.log(`âœ… Weekly summary created: ${summaryFile}`);
}

// Main execution
if (import.meta.main) {
  try {
    const note = generateLearningNote();
    const markdown = formatNoteAsMarkdown(note);
    const filepath = await saveNote(markdown, note.date);

    console.log(`âœ… Learning note created: ${filepath}`);
    console.log(`ğŸ“Š Topics: ${note.topics.join(", ")}`);
    console.log(`${note.mood} Mood level: ${note.focusLevel}/10`);

    // Generate weekly summary on Sundays
    if (note.dayOfWeek === "Sunday") {
      await generateWeeklySummary();
    }
  } catch (error) {
    console.error("âŒ Error generating note:", error);
    Deno.exit(1);
  }
}

export { generateLearningNote, formatNoteAsMarkdown, saveNote };
